# LLM-Learn 企业级项目框架使用指南

## 🚀 快速开始

### 1. 环境准备

确保您的系统满足以下要求：
- Python 3.8+
- PostgreSQL 12+
- Redis 6+
- Git

### 2. 克隆项目

```bash
git clone <your-repository-url>
cd LLM-learn
```

### 3. 创建虚拟环境

```bash
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate     # Windows
```

### 4. 安装依赖

```bash
pip install -e ".[dev]"
```

### 5. 配置环境变量

```bash
cp env.example .env
# 编辑 .env 文件，配置数据库连接等信息
```

### 6. 启动服务

使用提供的启动脚本：

```bash
./scripts/start.sh
```

或者手动启动：

```bash
# 数据库迁移
alembic upgrade head

# 启动应用
uvicorn src.main:app --reload
```

## 📁 项目结构

```
LLM-learn/
├── src/                    # 源代码目录
│   ├── core/              # 核心功能
│   │   ├── config.py      # 配置管理
│   │   ├── database.py    # 数据库连接
│   │   ├── logging.py     # 日志配置
│   │   ├── security.py    # 安全认证
│   │   └── cache.py       # 缓存管理
│   ├── api/               # API路由
│   │   └── v1/            # API版本
│   │       └── endpoints/ # API端点
│   ├── models/            # 数据模型
│   ├── services/          # 业务服务
│   ├── utils/             # 工具函数
│   └── main.py            # 应用入口
├── tests/                 # 测试目录
├── migrations/            # 数据库迁移
├── scripts/               # 脚本目录
├── docs/                  # 文档目录
├── docker/                # Docker配置
├── pyproject.toml         # 项目配置
├── alembic.ini           # 数据库迁移配置
├── docker-compose.yml    # Docker编排
└── README.md             # 项目说明
```

## 🔧 开发指南

### 代码规范

项目使用以下工具确保代码质量：

- **Black**: 代码格式化
- **isort**: 导入排序
- **flake8**: 代码检查
- **mypy**: 类型检查
- **pytest**: 单元测试

运行代码检查：

```bash
# 格式化代码
black src tests
isort src tests

# 代码检查
flake8 src tests
mypy src

# 运行测试
pytest --cov=src
```

### 预提交钩子

安装预提交钩子：

```bash
pre-commit install
```

这将自动在每次提交前运行代码检查。

### 数据库迁移

创建新的迁移：

```bash
alembic revision --autogenerate -m "描述变更"
```

应用迁移：

```bash
alembic upgrade head
```

回滚迁移：

```bash
alembic downgrade -1
```

## 🐳 Docker部署

### 使用Docker Compose

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f app

# 停止服务
docker-compose down
```

### 构建镜像

```bash
docker build -t llm-learn .
docker run -p 8000:8000 llm-learn
```

## 📊 监控和日志

### 应用监控

- **健康检查**: http://localhost:8000/health
- **详细健康检查**: http://localhost:8000/health/detailed
- **Prometheus指标**: http://localhost:8000/metrics
- **API文档**: http://localhost:8000/docs

### 日志配置

项目使用结构化日志，支持JSON格式输出。日志级别可通过环境变量 `LOG_LEVEL` 配置。

### 监控工具

- **Prometheus**: 指标收集 (端口 9090)
- **Grafana**: 可视化监控 (端口 3000)
- **Flower**: Celery监控 (端口 5555)

## 🔐 安全配置

### 环境变量

重要的安全配置：

```bash
# 密钥配置
SECRET_KEY=your-secret-key-here
JWT_SECRET_KEY=your-jwt-secret-key-here

# 数据库配置
DATABASE_URL=postgresql://user:password@localhost:5432/llm_learn

# Redis配置
REDIS_URL=redis://localhost:6379/0

# 外部API密钥
OPENAI_API_KEY=your-openai-api-key
ANTHROPIC_API_KEY=your-anthropic-api-key
```

### 安全最佳实践

1. 永远不要在代码中硬编码敏感信息
2. 使用强密码和密钥
3. 定期轮换密钥
4. 启用HTTPS
5. 配置CORS策略
6. 使用环境变量管理配置

## 🧪 测试

### 运行测试

```bash
# 运行所有测试
pytest

# 运行测试并生成覆盖率报告
pytest --cov=src --cov-report=html

# 运行特定测试
pytest tests/test_api.py -v

# 运行标记的测试
pytest -m "not slow"
```

### 测试类型

- **单元测试**: 测试单个函数或类
- **集成测试**: 测试组件间的交互
- **端到端测试**: 测试完整的用户流程

## 📈 性能优化

### 缓存策略

- 使用Redis缓存热点数据
- 实现缓存装饰器
- 设置合理的缓存过期时间

### 数据库优化

- 使用连接池
- 创建适当的索引
- 优化查询语句
- 使用异步操作

### 异步处理

- 使用Celery处理耗时任务
- 实现异步API端点
- 使用异步数据库操作

## 🚀 部署

### 生产环境部署

1. **环境准备**
   ```bash
   export ENVIRONMENT=production
   export DEBUG=false
   ```

2. **数据库迁移**
   ```bash
   alembic upgrade head
   ```

3. **启动应用**
   ```bash
   uvicorn src.main:app --host 0.0.0.0 --port 8000 --workers 4
   ```

### 使用Gunicorn

```bash
gunicorn src.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 使用Nginx

配置Nginx反向代理：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 🔧 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查数据库服务是否运行
   - 验证连接字符串
   - 确认数据库用户权限

2. **Redis连接失败**
   - 检查Redis服务状态
   - 验证Redis配置
   - 确认网络连接

3. **依赖安装失败**
   - 更新pip版本
   - 检查Python版本兼容性
   - 清理缓存重新安装

4. **端口被占用**
   - 检查端口使用情况
   - 修改配置文件中的端口
   - 停止占用端口的服务

### 日志分析

查看应用日志：

```bash
# 查看实时日志
tail -f logs/app.log

# 搜索错误日志
grep ERROR logs/app.log

# 分析日志统计
cat logs/app.log | jq '.level' | sort | uniq -c
```

## 📚 扩展开发

### 添加新的API端点

1. 在 `src/api/v1/endpoints/` 创建新的端点文件
2. 定义路由和业务逻辑
3. 在 `src/api/v1/__init__.py` 中注册路由
4. 编写相应的测试

### 添加新的数据模型

1. 在 `src/models/` 创建模型文件
2. 定义SQLAlchemy模型和Pydantic模式
3. 创建数据库迁移
4. 实现CRUD操作

### 添加新的服务

1. 在 `src/services/` 创建服务文件
2. 实现业务逻辑
3. 添加依赖注入
4. 编写单元测试

## 🤝 贡献指南

1. Fork项目
2. 创建特性分支
3. 提交更改
4. 推送到分支
5. 创建Pull Request

### 提交规范

使用约定式提交：

```
feat: 添加新功能
fix: 修复bug
docs: 更新文档
style: 代码格式调整
refactor: 代码重构
test: 添加测试
chore: 构建过程或辅助工具的变动
```

## 📞 支持

如果您遇到问题或需要帮助：

1. 查看本文档
2. 搜索Issues
3. 创建新的Issue
4. 联系维护团队

---

感谢使用LLM-Learn企业级项目框架！ 